(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const t of a)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function r(a){const t={};return a.integrity&&(t.integrity=a.integrity),a.referrerPolicy&&(t.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?t.credentials="include":a.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function e(a){if(a.ep)return;a.ep=!0;const t=r(a);fetch(a.href,t)}})();class b{constructor(){this.rawData=null,this.workbook=null,this.cities=[],this.products=[]}async loadExcel(s){return new Promise((r,e)=>{const a=new FileReader;a.onload=t=>{console.log("FileReader onload event triggered");try{const o=new Uint8Array(t.target.result);this.workbook=XLSX.read(o,{type:"array"});const i=this.workbook.Sheets.聚合结果||this.workbook.Sheets[this.workbook.SheetNames[0]];this.rawData=XLSX.utils.sheet_to_json(i),this.extractMetadata(),r({data:this.rawData,cities:this.cities,products:this.products})}catch(o){console.error("Error in XLSX processing:",o),e(new Error("Excel解析失败: "+o.message))}},a.onerror=t=>{console.error("FileReader error:",t),e(new Error("文件读取失败: "+t.message))},a.readAsArrayBuffer(s)})}extractMetadata(){!this.rawData||!this.rawData.length||(this.cities=[...new Set(this.rawData.map(s=>s.地市中文))],this.products=[...new Set(this.rawData.map(s=>s.销账大类))])}getRawData(){return this.rawData||[]}getCities(){return this.cities}getProducts(){return this.products}getWorkbook(){return this.workbook}}class C{constructor(){this.data=[],this.DEFAULT_CITY_ORDER=["广州","深圳","东莞","佛山","惠州"]}setData(s){this.data=s}getSortedCities(s,r=this.DEFAULT_CITY_ORDER){const e=[...new Set(s.map(a=>a.地市中文))];return e.sort((a,t)=>{const o=r.indexOf(a),i=r.indexOf(t);return o===-1&&i===-1?0:o===-1?1:i===-1?-1:o-i}),e}generateTimeRange(s,r){const e=[];let a=+s.slice(0,4),t=+s.slice(4);const o=+r.slice(0,4),i=+r.slice(4);for(;a<o||a===o&&t<=i;)e.push(`${a}${String(t).padStart(2,"0")}`),t++,t>12&&(t=1,a++);return e}filterData(s){const{cities:r,products:e,incomeType:a,timeRange:t,annualSwitch:o,workbook:i}=s,n=i.Sheets.聚合结果||i.Sheets[i.SheetNames[0]],c=XLSX.utils.sheet_to_json(n);let l=t.start,d=t.end;if(o){const u=c.map(y=>String(y.月份).padStart(6,"0")).sort();l=u[0],d=u[u.length-1]}const m=this.generateTimeRange(l,d),h=m.map(u=>`${+u.slice(0,4)-1}${u.slice(4)}`),p=c.filter(u=>(r.includes("all")||r.includes(u.地市中文))&&(e.includes("all")||e.includes(u.销账大类)));return{filteredData:p,field:a,range:m,prev:h,cities:this.getSortedCities(p)}}aggregateData(s,r){const e={};return s.forEach(a=>{const t=String(a.月份).padStart(6,"0"),o=a.地市中文,i=(+a[r]||0)/1e4;e[t]||(e[t]={}),e[t][o]=(e[t][o]||0)+i}),e}calculateProductComposition(s,r){const e={};return s.forEach(a=>{const t=a.地市中文,o=a.销账大类,i=(+a[r]||0)/1e4;e[t]||(e[t]={}),e[t][o]=(e[t][o]||0)+i}),e}calculateYoY(s,r,e,a){const t={},o={};a.forEach(c=>{t[c]=0,o[c]=0}),r.forEach(c=>{a.forEach(l=>{var d;t[l]+=((d=s[c])==null?void 0:d[l])||0})}),e.forEach(c=>{a.forEach(l=>{var d;o[l]+=((d=s[c])==null?void 0:d[l])||0})});const i=a.map(c=>Math.round(t[c]-o[c])),n=a.map(c=>o[c]?((t[c]-o[c])/o[c]*100).toFixed(1):0);return{current:t,previous:o,diff:i,rate:n}}calculateProductYoYTopN(s,r,e,a,t=10){const o={};return s.forEach(n=>{const c=String(n.月份).padStart(6,"0"),l=n.销账大类,d=(+n[r]||0)/1e4;o[l]||(o[l]={cur:0,pre:0}),e.includes(c)&&(o[l].cur+=d),a.includes(c)&&(o[l].pre+=d)}),Object.entries(o).map(([n,{cur:c,pre:l}])=>({prod:n,diff:c-l})).sort((n,c)=>c.diff-n.diff).slice(0,t)}calculateProductRevenueTopN(s,r,e,a=10){const t={};return s.forEach(i=>{const n=String(i.月份).padStart(6,"0");if(e.includes(n)){const c=i.销账大类,l=(+i[r]||0)/1e4;t[c]=(t[c]||0)+l}}),Object.entries(t).map(([i,n])=>({prod:i,sum:n})).sort((i,n)=>n.sum-i.sum).slice(0,a)}calculateMoM(s,r,e,a){const t={};s.forEach(l=>{const d=String(l.月份).padStart(6,"0");if(!e.includes(d))return;const m=l.地市中文,h=(+l[r]||0)/1e4;t[d]||(t[d]={}),t[d][m]=(t[d][m]||0)+h});const o=Object.keys(t).sort(),i={},n={};a.forEach(l=>{i[l]=[],n[l]=[]});for(let l=1;l<o.length;l++){const d=o[l-1],m=o[l];a.forEach(h=>{const p=t[d][h]||0,u=t[m][h]||0,y=Math.round(u-p),f=p?parseFloat((y/p*100).toFixed(1)):0;i[h].push(y),n[h].push(f)})}return{labels:o.slice(1).map(l=>l.slice(0,4)+"-"+l.slice(4)),momDiff:i,momRate:n}}}const S={primary:["#3498db","#2ecc71","#e74c3c","#9b59b6","#f1c40f","#1abc9c","#6CB071","#e67e22"]};class E{constructor(){this.charts={},this.colors=S.primary}renderAllCharts(s,r={}){const{aggregatedData:e,filteredData:a,field:t,range:o,prev:i,cities:n,products:c,composition:l,yoyData:d,topYoYProducts:m,topRevenueProducts:h,momData:p,monthlyCity:u,showValueLabels:y}=s;this.renderMonthlyTrend(e,t,o,n),this.renderMonthlyCityRevenue(u,t,n),this.renderIncomeComposition(l,n,c),this.renderCityComparison(a,t,n),this.renderProductBar(l,n,c),this.renderUserRevenue(a,t,n),this.renderYoYChart(d,n),this.renderTopYoYChart(m,y),this.renderTopRevenueChart(h,t,y),this.renderMoMChart(p,n,t)}destroyChart(s){const r=document.getElementById(s),e=Chart.getChart(r);e&&e.destroy()}renderMonthlyTrend(s,r,e,a){this.destroyChart("monthlyTrend");const t=Array.from(new Set(e.map(n=>n.slice(0,4)))).sort(),o=Array.from({length:12},(n,c)=>String(c+1).padStart(2,"0")+"月"),i=[];a.forEach((n,c)=>{t.forEach((l,d)=>{i.push({label:n+" "+l,data:o.map(m=>{const h=l+m.slice(0,2);return e.includes(h)?s[h]&&s[h][n]||0:null}),borderColor:this.colors[(c*t.length+d)%this.colors.length],fill:!1,tension:.4})})}),new Chart(document.getElementById("monthlyTrend").getContext("2d"),{type:"line",data:{labels:o,datasets:i},options:{responsive:!0,scales:{y:{title:{display:!0,text:`${r}(万元)`}}},plugins:{datalabels:{formatter:n=>Math.round(n),font:{family:"SimHei",weight:"bold"},color:"#000"}}}})}renderMonthlyCityRevenue(s,r,e){this.destroyChart("monthlyCityRevenue");const a=Object.keys(s).sort().map(o=>o.slice(0,4)+"-"+o.slice(4)),t=e.map((o,i)=>({label:o,data:Object.keys(s).sort().map(n=>s[n][o]||0),borderColor:this.colors[i%this.colors.length],fill:!1,tension:.4}));new Chart(document.getElementById("monthlyCityRevenue").getContext("2d"),{type:"line",data:{labels:a,datasets:t},options:{responsive:!0,scales:{y:{title:{display:!0,text:`${r}(万元)`}}},plugins:{datalabels:{formatter:o=>Math.round(o),font:{family:"SimHei",weight:"bold"},color:"#000"}}}})}renderIncomeComposition(s,r,e){this.destroyChart("incomeComposition");const a=r.map((t,o)=>({label:t,data:e.map(i=>{var n;return((n=s[t])==null?void 0:n[i])||0}),backgroundColor:e.map((i,n)=>this.colors[n%this.colors.length])}));new Chart(document.getElementById("incomeComposition").getContext("2d"),{type:"doughnut",data:{labels:e,datasets:a},options:{responsive:!0,cutout:"50%",plugins:{datalabels:{display:!1}}}})}renderCityComparison(s,r,e){this.destroyChart("cityComparison");const a=e.map(t=>s.filter(o=>o.地市中文===t).reduce((o,i)=>o+(+i[r]||0)/1e4,0));new Chart(document.getElementById("cityComparison").getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:`${r}(万元)`,data:a,backgroundColor:e.map((t,o)=>this.colors[o%this.colors.length])}]},options:{responsive:!0,plugins:{datalabels:{formatter:t=>Math.round(t),color:"#000",font:{family:"SimHei",weight:"bold"},anchor:"center",align:"start"}}}})}renderProductBar(s,r,e){this.destroyChart("productBar");const a=r.map((t,o)=>({label:t,data:e.map(i=>{var n;return((n=s[t])==null?void 0:n[i])||0}),backgroundColor:this.colors[o%this.colors.length]}));new Chart(document.getElementById("productBar").getContext("2d"),{type:"bar",data:{labels:e,datasets:a},options:{responsive:!0,plugins:{datalabels:{display:!1}}}})}renderUserRevenue(s,r,e){this.destroyChart("userRevenue");const a=e.map((t,o)=>({label:t,data:s.filter(i=>i.地市中文===t).map(i=>({x:+i.用户数||0,y:(+i[r]||0)/1e4})),backgroundColor:this.colors[o%this.colors.length]}));new Chart(document.getElementById("userRevenue").getContext("2d"),{type:"scatter",data:{datasets:a},options:{responsive:!0,scales:{x:{title:{display:!0,text:"用户数"}},y:{title:{display:!0,text:`${r}(万元)`}}},plugins:{datalabels:{display:!1}}}})}renderYoYChart(s,r){this.destroyChart("yoyChart");const{diff:e,rate:a}=s;new Chart(document.getElementById("yoyChart").getContext("2d"),{data:{labels:r,datasets:[{type:"bar",label:"同比增收(万元)",data:e,backgroundColor:r.map((t,o)=>this.colors[o%this.colors.length])},{type:"line",label:"同比增幅(%)",data:a,yAxisID:"y1",borderColor:r.map((t,o)=>this.colors[o%this.colors.length]),fill:!1,tension:.4}]},options:{responsive:!0,scales:{y:{title:{display:!0,text:"同比增收(万元)"}},y1:{position:"right",grid:{drawOnChartArea:!1},title:{display:!0,text:"同比增幅(%)"},ticks:{callback:t=>t+"%"}}},plugins:{datalabels:{display:!0,anchor:t=>t.dataset.type==="bar"?"center":"start",align:t=>t.dataset.type==="bar"?"center":"top",formatter:(t,o)=>o.dataset.type==="bar"?t:t+"%",color:t=>t.dataset.type==="bar"?"#000":"#c00",font:{weight:"bold"}}}}})}renderTopYoYChart(s,r){this.destroyChart("topYoYChart"),new Chart(document.getElementById("topYoYChart").getContext("2d"),{type:"bar",data:{labels:s.map(e=>e.prod),datasets:[{label:"同比增收(万元)",data:s.map(e=>e.diff),backgroundColor:s.map((e,a)=>this.colors[a%this.colors.length])}]},options:{indexAxis:"y",responsive:!0,plugins:{datalabels:{formatter:e=>Math.round(e),display:r,color:"#000",font:{family:"SimHei",weight:"bold"}}}}})}renderTopRevenueChart(s,r,e){this.destroyChart("topRevenueChart"),new Chart(document.getElementById("topRevenueChart").getContext("2d"),{type:"bar",data:{labels:s.map(a=>a.prod),datasets:[{label:`${r}(万元)`,data:s.map(a=>a.sum),backgroundColor:s.map((a,t)=>this.colors[t%this.colors.length])}]},options:{indexAxis:"y",responsive:!0,plugins:{datalabels:{formatter:a=>Math.round(a),display:e,color:"#000",font:{family:"SimHei",weight:"bold"}}}}})}renderMoMChart(s,r,e){this.destroyChart("momChart");const{labels:a,momDiff:t,momRate:o}=s,i=[];r.forEach((n,c)=>{const l=this.colors[c%this.colors.length];i.push({type:"bar",label:n+" 环比增收",data:t[n],backgroundColor:l}),i.push({type:"line",label:n+" 环比增幅(%)",data:o[n],yAxisID:"y1",borderColor:l,fill:!1})}),new Chart(document.getElementById("momChart").getContext("2d"),{data:{labels:a,datasets:i},options:{responsive:!0,scales:{y:{title:{display:!0,text:"环比增收(万元)"}},y1:{position:"right",grid:{drawOnChartArea:!1},title:{display:!0,text:"环比增幅(%)"},ticks:{callback:n=>n+"%"}}},plugins:{datalabels:{formatter:(n,c)=>c.dataset.type==="bar"?n:n+"%",anchor:"end",align:"end"}}}})}}class w{constructor(){this.dataLoader=new b,this.dataProcessor=new C,this.chartRenderer=new E,this.state={cities:[],products:[],selectedCities:[],selectedProducts:[],incomeType:"折后收入",timeRange:{start:"",end:""},annualSwitch:!1,showValueLabels:!1,workbook:null,isDataLoaded:!1},this.colors=S.primary}init(){this.initDOMElements(),this.initEventListeners(),this.initYearMonthSelectors()}initDOMElements(){this.fileInput=document.getElementById("fileInput"),this.fileLabel=document.getElementById("fileLabel"),this.statusText=document.getElementById("statusText"),this.citySelect=document.getElementById("citySelect"),this.productSelect=document.getElementById("productSelect"),this.incomeTypeSelect=document.getElementById("incomeTypeSelect"),this.startYearSelect=document.getElementById("startYearSelect"),this.startMonthSelect=document.getElementById("startMonthSelect"),this.endYearSelect=document.getElementById("endYearSelect"),this.endMonthSelect=document.getElementById("endMonthSelect"),this.annualSwitch=document.getElementById("annualSwitch"),this.showValueLabels=document.getElementById("showValueLabels"),this.analyzeBtn=document.getElementById("analyzeBtn"),this.momBtn=document.getElementById("momBtn")}initEventListeners(){this.fileLabel.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",s=>this.handleFileUpload(s)),this.citySelect.addEventListener("change",s=>this.handleCitySelection(s)),this.productSelect.addEventListener("change",s=>this.handleProductSelection(s)),this.incomeTypeSelect.addEventListener("change",()=>this.updateState()),this.startYearSelect.addEventListener("change",()=>this.updateState()),this.startMonthSelect.addEventListener("change",()=>this.updateState()),this.endYearSelect.addEventListener("change",()=>this.updateState()),this.endMonthSelect.addEventListener("change",()=>this.updateState()),this.annualSwitch.addEventListener("change",()=>this.updateState()),this.showValueLabels.addEventListener("change",()=>{this.state.showValueLabels=this.showValueLabels.checked,this.state.isDataLoaded&&this.analyzeData()}),this.analyzeBtn.addEventListener("click",()=>this.analyzeData()),this.momBtn.addEventListener("click",()=>this.analyzeMoM())}initYearMonthSelectors(){const s=new Date().getFullYear(),r=[s-1,s,s+1],e=Array.from({length:12},(a,t)=>String(t+1).padStart(2,"0"));[this.startYearSelect,this.endYearSelect].forEach(a=>{a.innerHTML="",r.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,a.appendChild(o)})}),[this.startMonthSelect,this.endMonthSelect].forEach(a=>{a.innerHTML="",e.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t+"月",a.appendChild(o)})}),this.startYearSelect.value=s,this.startMonthSelect.value="01",this.endYearSelect.value=s,this.endMonthSelect.value="12",this.updateState()}async handleFileUpload(s){const r=s.target.files[0];if(r){this.statusText.textContent="加载中...";try{const e=await this.dataLoader.loadExcel(r);this.state.cities=e.cities,this.state.products=e.products,this.state.workbook=this.dataLoader.getWorkbook(),this.state.isDataLoaded=!0,this.updateCitySelector(),this.updateProductSelector(),this.statusText.textContent="就绪",this.analyzeBtn.disabled=this.momBtn.disabled=!1}catch(e){this.statusText.textContent="解析错误",this.analyzeBtn.disabled=this.momBtn.disabled=!0,alert("⚠️ Excel 解析失败: "+e.message)}}}updateCitySelector(){this.citySelect.innerHTML='<option value="all">[ 全/取消 ]</option>',this.state.cities.forEach((s,r)=>{const e=document.createElement("option");e.value=s,e.textContent=s,e.selected=!0,e.style.background=this.colors[r%this.colors.length],this.citySelect.appendChild(e)}),this.state.selectedCities=["all"]}updateProductSelector(){this.productSelect.innerHTML='<option value="all">[ 全/取消 ]</option>',this.state.products.forEach((s,r)=>{const e=document.createElement("option");e.value=s,e.textContent=s,e.selected=!0,e.style.background=this.colors[r%this.colors.length],this.productSelect.appendChild(e)}),this.state.selectedProducts=["all"]}handleCitySelection(s){const r=Array.from(this.citySelect.options);if(s.target.value==="all"){const e=r.every(a=>a.selected);r.forEach(a=>a.selected=!e)}this.state.selectedCities=Array.from(this.citySelect.selectedOptions).map(e=>e.value),this.updateState()}handleProductSelection(s){const r=Array.from(this.productSelect.options);if(s.target.value==="all"){const e=r.every(a=>a.selected);r.forEach(a=>a.selected=!e)}this.state.selectedProducts=Array.from(this.productSelect.selectedOptions).map(e=>e.value),this.updateState()}updateState(){this.state.incomeType=this.incomeTypeSelect.value,this.state.timeRange.start=`${this.startYearSelect.value}${this.startMonthSelect.value}`,this.state.timeRange.end=`${this.endYearSelect.value}${this.endMonthSelect.value}`,this.state.annualSwitch=this.annualSwitch.checked,this.state.showValueLabels=this.showValueLabels.checked}analyzeData(){try{const s=this.dataProcessor.filterData({cities:this.state.selectedCities,products:this.state.selectedProducts,incomeType:this.state.incomeType,timeRange:this.state.timeRange,annualSwitch:this.state.annualSwitch,workbook:this.state.workbook}),{filteredData:r,field:e,range:a,prev:t,cities:o}=s;if(!r.length){alert("无匹配数据");return}const i=this.dataProcessor.aggregateData(r,e),n=this.dataProcessor.calculateProductComposition(r,e),c=this.dataProcessor.calculateYoY(i,a,t,o),l=this.dataProcessor.calculateProductYoYTopN(r,e,a,t),d=this.dataProcessor.calculateProductRevenueTopN(r,e,a),m=this.dataProcessor.calculateMoM(r,e,a,o),h={};r.forEach(p=>{const u=String(p.月份).padStart(6,"0"),y=p.地市中文,f=(+p[e]||0)/1e4;h[u]||(h[u]={}),h[u][y]=(h[u][y]||0)+f}),this.chartRenderer.renderAllCharts({aggregatedData:i,filteredData:r,field:e,range:a,prev:t,cities:o,products:[...new Set(r.map(p=>p.销账大类))],composition:n,yoyData:c,topYoYProducts:l,topRevenueProducts:d,momData:m,monthlyCity:h,showValueLabels:this.state.showValueLabels})}catch(s){alert("分析出错："+s.message),console.error(s)}}analyzeMoM(){try{const s=this.dataProcessor.filterData({cities:this.state.selectedCities,products:this.state.selectedProducts,incomeType:this.state.incomeType,timeRange:this.state.timeRange,annualSwitch:this.state.annualSwitch,workbook:this.state.workbook}),{filteredData:r,field:e,range:a,cities:t}=s;if(!r.length){alert("无匹配数据");return}const o=this.dataProcessor.calculateMoM(r,e,a,t);this.chartRenderer.renderMoMChart(o,t,e)}catch(s){alert("环比出错："+s.message),console.error(s)}}}document.addEventListener("DOMContentLoaded",()=>{try{new w().init(),console.log("应用初始化完成")}catch(g){console.error("应用初始化失败:",g),alert("应用初始化失败: "+g.message)}});
